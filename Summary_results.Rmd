---
title: "Summary of data uncertainty results"
author: "Emily Simmonds"
date: "2023-03-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)

# load packages
library(tidyverse)

# load all summary data

load("./Data files/2x2/summary_results_2x2.RData")
# re-order the factor levels
summary_results <- summary_results %>%
  dplyr::mutate(scenario = as.factor(scenario),
                scenario = plyr::revalue(scenario, 
                                         c("baseline"="baseline", 
                                           "adult_missing"="adult \nmissing",
                                           "juvenile_missing" = "juvenile \nmissing",
                                           "random_error" = "random \nerror",
                                           "random_missing" = 
                                             "random \nmissing")),
                scenario = fct_relevel(scenario, 
                                       "baseline",
                                       "random \nerror",
                                       "random \nmissing",
                                       "adult \nmissing",
                                       "juvenile \nmissing"))
summary_results_2x2 <- summary_results
load("./Data files/3x3/summary_results_3x3.RData")
# re-order the factor levels
summary_results <- summary_results %>%
  dplyr::mutate(scenario = as.factor(scenario),
                scenario = plyr::revalue(scenario, 
                                         c("baseline"="baseline", 
                                           "adult_missing"="adult \nmissing",
                                           "juvenile_missing" = "juvenile \nmissing",
                                           "random_error" = "random \nerror",
                                           "random_missing" = 
                                             "random \nmissing")),
                scenario = fct_relevel(scenario, 
                                       "baseline",
                                       "random \nerror",
                                       "random \nmissing",
                                       "adult \nmissing",
                                       "juvenile \nmissing"))
summary_results_3x3 <- summary_results
load("./Data files/5x5/summary_results_5x5.RData")
# re-order the factor levels
summary_results <- summary_results %>%
  dplyr::mutate(scenario = as.factor(scenario),
                scenario = plyr::revalue(scenario, 
                                         c("baseline"="baseline", 
                                           "adult_missing"="adult \nmissing",
                                           "juvenile_missing" = "juvenile \nmissing",
                                           "random_error" = "random \nerror",
                                           "random_missing" = 
                                             "random \nmissing")),
                scenario = fct_relevel(scenario, 
                                       "baseline",
                                       "random \nerror",
                                       "random \nmissing",
                                       "adult \nmissing",
                                       "juvenile \nmissing"))
summary_results_5x5 <- summary_results

summary_results_all <- bind_rows(summary_results_2x2,
                                 summary_results_3x3,
                                 summary_results_5x5) %>%
  mutate(matrix_size = c(rep(2, 17500),
                         rep(3, 25000),
                         rep(5, 40000)))



# load all true in ci data

true_ci_2x2 <- read.csv("./Data files/2x2/true_in_ci_2x2.csv")
true_ci_3x3 <- read.csv("./Data files/3x3/true_in_ci_3x3.csv")
true_ci_5x5 <- read.csv("./Data files/5x5/true_in_ci_5x5.csv")

true_ci_all <-  bind_rows(true_ci_2x2,
                          true_ci_3x3,
                          true_ci_5x5) %>%
  mutate(matrix_size = c(rep(2, 175),
                         rep(3, 250),
                         rep(5, 400))) %>%
  dplyr::mutate(scenario = fct_relevel(scenario, 
                                       "baseline",
                                       "random \nerror",
                                       "random \nmissing",
                                       "adult \nmissing",
                                       "juvenile \nmissing"))

###############################################################################

colours_scenario <- c("#FFFFFF", "#feff54", "#30666B", "#134263", "#1E2E39")

colfunc<-colorRampPalette(c("white", "orangered"))

colours_size <- colfunc(5)

```

## Introduction

What I have done and roughly why

This document covers results relating to simulations looking at fecundity data
uncertainty. 

The aim of this section is to answer the questions:

* **How does missing fecundity data impact accuracy and precision of lambda 
estimates?**

* **How does bias in fecundity data impact accuracy and precision of lambda?**

## Method

* First I selected 2x2 matrices from COMADRE (published since 2010 and in
peer reviewed literature). I reduced these to only matrices where both stage
classes breed. I then organised these based on the sum of their fecundity values.
This gave 10 matrices, so I selected every other matrix from the lowest fecundity
value to the second highest. This gave a range of different levels of fecundity.

* Next I expanded these five 2x2 matrices to 3x3 and 5x5. I did this by repeating
the survival and fecundity values

## Results: Accuracy

Brief metric of accuracy: error so difference between estimate and true value. 

### Accuracy - by scenario and matrix size

facet by matrix size (pick matrix 3 only) and colour by scenario

```{r accuracy_by_matrix_size}

# use the full data frame for plotting

ggplot(data = filter(summary_results_all, parameter == "lambda"),
       aes(x = scenario,
           y = error, fill = scenario,
           colour = scenario)) +
  geom_violin(scale = "width", draw_quantiles = c(0.025, 0.5, 0.975)) +
  scale_fill_manual(values = colours_scenario) +
  scale_color_manual(values = c("black", "grey50", "white", "white", "white"))+
  plain_theme() +
  facet_grid(rows = vars(matrix_size))+
  labs(x = "", y = "Estimate - True") +
  theme(legend.position = "none")

```

### Accuracy - by scenario and fecundity:survival ratio

facet by fecundity:survival ratio and colour by scenario

```{r accuracy_by_ratio}

ggplot(data = filter(summary_results, parameter == "lambda"),
       aes(x = scenario,
           y = error, fill = scenario,
           colour = scenario)) +
  geom_violin(scale = "width", draw_quantiles = c(0.025, 0.5, 0.975)) +
  scale_fill_manual(values = colours_scenario) +
  scale_color_manual(values = c("black", "grey50", "white", "white", "white"))+
  plain_theme() +
  facet_grid(rows = vars(matrix_number))+
  labs(x = "", y = "Estimate - True") +
  theme(legend.position = "none")

```

## Results: Precision

Precision is measured by credible interval width.

### Precision - across all combos

facet by ratio and size with colour code of scenario. All seem very similar. 

```{r precision}

ggplot(data = filter(summary_results_all, parameter == "lambda"),
       aes(x = scenario,
           y = CI_width, fill = scenario, colour = scenario)) +
  geom_violin(scale = "width", draw_quantiles = c(0.025, 0.5, 0.975)) +
  scale_fill_manual(values = colours_scenario) +
  scale_color_manual(values = c("black", colours[2], "grey", "grey", "grey"))+
  plain_theme() +
  facet_grid(rows = vars(matrix_number), cols = vars(matrix_size))+
  labs(x = "", y = "CI width") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45))

```

## Results: Coverage (accuracy of precision)

Coverage is the number of times the true parameter falls in the 95% credible
interval. Would expect it to be 95% but this is not always the case. 

This gives a measure of how accurate our precision metric is. 

### Coverage - lambda by scenario

```{r coverage_lambda_scenario}

# first format the data

true_ci_scenario <- true_ci_all %>%
  group_by(scenario, parameter) %>% 
  summarise(mean = mean(percent*100))

ggplot(data = filter(true_ci_scenario, parameter == "lambda"),
       aes(x = scenario,
           y = mean, fill = scenario, colour = scenario)) +
  geom_col() +
  geom_hline(yintercept = 95) +
  scale_fill_manual(values = colours_scenario) +
  scale_color_manual(values = c("black", colours[2], "grey", "grey", "grey"))+
  plain_theme() +
  #facet_grid(rows = vars(matrix_number), cols = vars(matrix_size))+
  labs(x = "", y = "Percentage true in CI") +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45)) +
  ylim(0,100)
```

### Coverage - lambda by matrix size

```{r coverage_lambda_size}
# first format the data

true_ci_size <- true_ci_all %>%
  mutate(matrix_size = as.factor(matrix_size)) %>%
  group_by(matrix_size, parameter) %>% 
  summarise(mean = mean(percent*100))

ggplot(data = filter(true_ci_size, parameter == "lambda"),
       aes(x = matrix_size,
           y = mean, fill = matrix_size, colour = matrix_size)) +
  geom_col() +
  geom_hline(yintercept = 95) +
  scale_fill_manual(values = colours_size[c(1,2,5)]) +
  scale_color_manual(values = c("grey", "grey", "grey"))+
  plain_theme() +
  #facet_grid(rows = vars(matrix_number), cols = vars(matrix_size))+
  labs(x = "Matrix size", y = "Percentage true in CI") +
  theme(legend.position = "none") +
  ylim(0,100)
```

### Coverage - lambda by fecundity:survival ratio

```{r coverage_lambda_ratio}

ggplot(data = filter(true_ci_all, parameter == "lambda",
                     matrix_size == 3),
       aes(x = scenario,
           y = percent*100, fill = scenario, colour = scenario)) +
  geom_col() +
  geom_hline(yintercept = 95) +
  scale_fill_manual(values = colours_scenario) +
  scale_color_manual(values = c("black", colours[2], "grey", "grey", "grey"))+
  plain_theme() +
  facet_grid(rows = vars(matrix_number))+
  labs(x = "", y = "Percentage true in CI") +
  theme(legend.position = "none") +
  ylim(0,100)

```
